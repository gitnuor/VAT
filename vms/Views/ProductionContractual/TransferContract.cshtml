@model vms.entity.models.ContractualProduction
@{
    ViewData["Title"] = "TransferContract";
    
    string vendor = "";
}

@section contentheader
    {
    <div class="p-3 page-header">
        Transfer Contract
        <div class="d-flex justify-content-start">

            
        </div>
    </div>
    <div class="col-12 d-flex">
        <ul class="nav nav-pills mt-3 mr-auto align-bottom">
        </ul>
        
    </div>
}

<input type="hidden" class="form-control" id="ProductId" name="ProductId" />
<h4>Contractual Production</h4>
<div class="row">
    <div class="col-12">
        <table class="table table-bordered table-responsive">
            <thead>
                <tr>

                    <th class="text-center">
                        Contract No
                    </th>

                    <th class="text-center">
                        Vendor
                    </th>
                    <th class="text-center">
                        ContractDate
                    </th>

                </tr>
            </thead>

            @if (Model != null)
            {
                <tbody>
                    <tr>
                        <td class="text-center">
                            @Model.ContractNo
                        </td>

                        <td class="text-center">

                            @{
                                vendor = Model.Vendor == null ? "" : Model.Vendor.Name;
                            }
                            @vendor
                        </td>
                        <td class="text-right">
                            @Model.ContractDate.ToShortDateString()
                        </td>
                    </tr>

                </tbody>
            }

        </table>
        </div>
    </div>
        <h4>Contractual Production Product Details</h4>
        <div class="row">
            <div class="col-12">
                <table class="table table-bordered table-responsive">
                    <thead>
                        <tr>

                            <th class="text-center">
                                Finish Goods Name
                            </th>

                            <th class="text-center">
                                Qty
                            </th>
                            <th class="text-center">
                                Unit
                            </th>

                        </tr>
                    </thead>

                    @if (Model.ContractualProductionProductDetails.Any())
                    {
                        <tbody>
                            @foreach (var item in Model.ContractualProductionProductDetails)
                            {
                                <tr>
                                    <td class="text-center">
                                        @item.Product.Name
                                    </td>

                                    <td class="text-center">
                                        @item.Quantity
                                    </td>
                                    <td class="text-right">
                                        @item.Product.MeasurementUnit.Name
                                    </td>
                                </tr>
                            }


                        </tbody>
                    }

                </table>
                </div>
            </div>
                <h4>
                    Contractual Production Transfer Raw Material
                </h4>
                <form method="post" id="productionConRaw">
                    <div class="row">
                        <div class="col-md-12 ">
                            <div class="row">
                                <div class="col-md-2">
                                    <div class="form-group form-md-line-input">
                                        <div>
                                            <label class="labelColor">Transfer Date<span class="label-color">*</span></label>
                                            <input type="text" class="form-control" id="TransfereDate" name="TransfereDate" placeholder="#" value="@DateTime.Now.ToShortDateString()">
                                        </div>
                                    </div>
                                </div>


                                <div class="col-md-2">
                                    <div class="form-group form-md-line-input">
                                        <div>
                                            <label class="labelColor">Location<span class="label-color">*</span></label>
                                            <input type="text" class="form-control" id="Location" name="Location" placeholder="#">
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-2">
                                    <div class="form-group form-md-line-input">
                                        <div>
                                            <label class="labelColor">Challan No<span class="label-color">*</span></label>
                                            <input type="text" class="form-control" id="ChallanNo" name="ChallanNo">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group form-md-line-input">
                                        <div>
                                            <label class="labelColor">Challan Issue Date<span class="label-color">*</span></label>
                                            <input type="text" class="form-control" id="ChallanIssueDate" name="ChallanIssueDate" value="@DateTime.Now.ToShortDateString()">
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div class="col-md-12 ">
                            <h4>Contractual Production Transfer Raw Material Details</h4>
                            <table class="table table-bordered" id="gridTable">
                                <thead>
                                    <tr>
                                        <th>Serial</th>
                                        <th>Raw Material</th>
                                        <th>Qty.</th>
                                        <th>M. Unit</th>
                                        <th></th>
                                    </tr>
                                </thead>

                                <tbody id="tblCVPD"></tbody>

                                <tfoot>
                                    <tr>

                                        <td></td>
                                        <td class="form-group form-md-line-input">
                                            <div>
                                                <input type="text" class="form-control" id="Product" name="Product">
                                            </div>
                                        </td>
                                        <td class="form-group form-md-line-input">
                                            <div>
                                                <input type="text" class="form-control" id="UsedQuantity" name="UsedQuantity">
                                            </div>
                                        </td>
                                        <td class="form-group form-md-line-input has-info">
                                            <select id="unit" name="unit" class="form-control" asp-items="ViewBag.MeasurementUnitId">
                                                <option value=null></option>
                                            </select>
                                        </td>
                                        <td class="single-button-action-column">
                                            <a id="add" class="btn btn-sm btn-success" aria-label="Left Align">
                                                <i class="bi bi-plus-lg"></i>
                                            </a>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-primary btn-sm" id="save"><i class="bi bi-check-lg"></i> Submit</button>
                        <button type="button" value="Reset" class="btn  btn-warning btn-sm" onclick="location.reload();"><i class="bi bi-arrow-repeat"></i> Reset</button>
                        <a asp-action="Index" class="btn btn-secondary btn-sm"><i class="bi bi-slash-circle"></i> Cancel</a>
                    </div>
                </form>
                @section Scripts{
                    <script src="~/js/typeahead.bundle.js"></script>
                    <script src="~/js/jquery-ui.js"></script>
                    <script>

        var ProductionContractVendor = {
            init: function() {},
            count: 1,
            ProductionContractVendorDetailList: [],
            item: [],
            gridTableEmpty: function() {
                $('#ProductId').val('');
                $('#Product').val('');
                $('#UsedQuantity').val('');
                $('#unit').val('');
            },

            isNumber:function (n) {
                return !isNaN(parseFloat(n)) && isFinite(n);
            },

            add: function () {

                var productName = $('#Product').val();
                var productId = $('#ProductId').val();
                var unit = $('#unit').val();
                var unitName  =$("#unit option:selected").text();
                var qty = $('#UsedQuantity').val();
                if (productId>0) {

                    var canAdd = true;

                    $.each(ProductionContractVendor.ProductionContractVendorDetailList,
                        function (i, v) {
                            if (ProductionContractVendor.ProductionContractVendorDetailList[i].ProductId == productId) {
                                alert('Sorry! Raw Material Exists.');
                                canAdd = false;

                            }

                        });
                    if (!parseInt(qty)) {
                        alert('Number of used qty is inValid!');
                        canAdd = false;
                    }
                    if (canAdd) {
                        var data = new Object();
                        data.RawMaterialId = productId;
                        data.Quantity = qty;
                        data.MeasurementUnitId = unit;

                        ProductionContractVendor.ProductionContractVendorDetailList.push(data);

                        var html = '<tr id="' +
                            data.RawMaterialId +
                            '">' +
                            '<td>' +
                            ProductionContractVendor.count +
                            '</td>' +
                            '<td>' +
                            productName +
                            '</td>' +
                            '<td>' +
                            qty +
                            '</td>' +
                            '<td>' +
                            unitName +
                            '</td>' +
                            '<td><span onclick="Delete(' +
                            data.RawMaterialId +
                            ')"  class="glyphicon glyphicon-minus btn-xs"></a></span></td>';

                        html += '</tr>';

                        $("table#gridTable > tbody").append(html);
                        ProductionContractVendor.gridTableEmpty();
                        ProductionContractVendor.count++;

                    }
                }

            },

            delete: function (id) {

                $.each(ProductionContractVendor.ProductionContractVendorDetailList,
                    function (i, v) {
                        if (ProductionContractVendor.ProductionContractVendorDetailList[i].RawMaterialId == id) {

                            ProductionContractVendor.ProductionContractVendorDetailList.splice(i, 1);
                            ProductionContractVendor.count--;
                        }
                        $("tr#" + id).remove().fadeOut();

                    });

            },


             Save: function () {
                 var TransfereDate = $('#TransfereDate').val();
                 var Location = $('#Location').val();
                 var ChallanNo = $('#ChallanNo').val();
                 var ChallanIssueDate = $('#ChallanIssueDate').val();
                 var reqEntry = new Object();
                 reqEntry.ContractualProductionId = @Model.ContractualProductionId;
                 reqEntry.TransfereDate = TransfereDate;
                 reqEntry.Location = Location;
                 reqEntry.ChallanNo = ChallanNo;
                 reqEntry.ChallanIssueDate = ChallanIssueDate;

                 reqEntry.Details = ProductionContractVendor.ProductionContractVendorDetailList;
                 $.ajax({
                     url: '@Url.Action("TransferRawMaterial", "ProductionContractual")',
                     data: { vm: reqEntry, "__RequestVerificationToken": $("input[name=__RequestVerificationToken]").val()},
                     type: "POST",

                     dataType: "json",
                     beforeSend: function () {
                         $("#loading").show();
                     },

                     success: function (result) {
                         $("#showData").html("");

                         if (result == false) {
                             alert("Please add atleast one BOM");
                         }
                         else {
                             window.location.href = '@Url.Action("Index", "ProductionContractual")';
                         }
                     },
                     error: function (x, e) {
                         $("#loading").hide();
                         alert('error');
                     }
                 });
            },
            product : {
                init: function () { },

                productAutoComplete: function () {
                    var materialforrequsition = {
                        Initialize: function () {
                            materialforrequsition.Typehead();
                        },

                        Typehead: function () {
                            $('#Product').typeahead('destroy');
                            $('#Product').typeahead({
                                    hint: true,
                                    highlight: true,
                                    minLength: 2,
                                },
                                {
                                    items: 8,
                                    name: 'Product',
                                    displayKey: function (s) {
                                        return s.name;
                                    },
                                    property: "ProductId",
                                    source: function (strmaterial, process) {
                                        var url = '@Url.Content("~/Products/ContractVendorTransferRawMaterialProductAutoComplete")';
                                        return $.getJSON(url,
                                            {
                                                 filterText: $("#Product").val()
                                            }, function (Data) {

                                            return process(Data);
                                        });
                                    },
                                    updater: function (item) {
                                        return item.name;
                                    }
                                }).on('typeahead:selected', function (obj, datum) {

                                    $("#ProductId").val(datum.id);
                                    $("#unit").val(datum.unit);

                            });
                            $("#Product").focus();

                        }
                    }
                    materialforrequsition.Initialize();
                }
            }
        }

        $(document).ready(function() {

            $('#productionConRaw').validate({
                errorClass: 'help-block animation-slideDown',
                errorElement: 'div',
                errorPlacement: function (error, e) {
                    e.parents('.form-group >div').append(error);
                },
                highlight: function (e) {
                    $(e).closest('.form-group').removeClass('has-success has-error').addClass('has-error');
                    $(e).closest('.help-block').remove();
                },

                success: function (e) {
                    e.closest('.form-group').removeClass('has-success has-error');
                    e.closest('.help-block').remove();
                },
                rules: {
                    TransfereDate: {
                        required: true,
                        date: true
                    },
                    Location: {
                        required: true,
                        maxlength: 50
                    },
                    ChallanNo: {
                        required: true,
                        maxlength: 50
                    },
                    ChallanIssueDate: {
                        required: true,
                        date: true
                    },
                    Product: {
                        required: true
                    },
                    UsedQuantity: {
                        required: true,
                        number: true
                    }


                },
                messages: {
                    TransfereDate: {
                        required: 'Please provide Discount',
                        date: 'Provide a valid Date'
                    },
                    Location: {
                        required: 'Provide Location',
                        maxlength: 'Location Can not be more than 50 char'
                    },
                    ChallanNo: {
                        required: 'Provide ChallanNo',
                        maxlength: 'ChallanNo Can not be more than 50 char'
                    },
                    ChallanIssueDate: {
                        required: 'Please provide ChallanIssueDate',
                        date: 'Provide a valid Date'
                    },
                   Product: {
                        required: 'Please provide Product'
                    },
                    UsedQuantity: {
                        required: 'Please provide UsedQuantity',
                        number: 'Provide Valid Number'
                    }


                }
            });
            $('#add').click(function () {
                $("#Product").rules('add', 'required');
                $("#UsedQuantity").rules('add', 'required');
                $("#TransfereDate").rules('remove', 'required');
                $("#Location").rules('remove', 'required');
                $("#ChallanNo").rules('remove', 'required');
                $("#ChallanIssueDate").rules('remove', 'required');
                if ($("#productionConRaw").valid()) {
                    ProductionContractVendor.add();
                    return true
                }
                else {
                    return false;
                }

            });

            $('#save').click(function () {
                $("#TransfereDate").rules('add', 'required');
                $("#Location").rules('add', 'required');
                $("#ChallanNo").rules('add', 'required');
                $("#ChallanIssueDate").rules('add', 'required');
                $("#Product").rules('remove', 'required');
                $("#UsedQuantity").rules('remove', 'required');

                if ($("#productionConRaw").valid()) {
                    var rowPurchase = $('#tblCVPD tr').length;

                    if (rowPurchase > 0) {
                        if (confirm('Are you sure?')) {
                            ProductionContractVendor.Save();
                            return true
                        }
                    }
                    else {
                        alert('Add Product Details');
                    }
                }
                else {
                    alert('Please Enter Required Fields!');

                    return false;
                }


            });
            ProductionContractVendor.product.productAutoComplete();
            //$("#TransfereDate").datepicker();
            //$("#TransfereDate").datepicker('option', 'dateFormat', 'dd M, yy');

            //$("#ChallanIssueDate").datepicker();
            //$("#ChallanIssueDate").datepicker('option', 'dateFormat', 'dd M, yy');


        });

        function Delete(id) {
            ProductionContractVendor.delete(id);
        }

        function resetDate() {

            $("#Location").val('');
            $("#ChallanNo").val('');
            $("#TransfereDate").datepicker().datepicker("setDate", new Date());
            $("#ChallanIssueDate").datepicker().datepicker("setDate", new Date());


            $("#ChallanIssueDate").datepicker('option', 'dateFormat', 'dd M, yy');
            $("#TransfereDate").datepicker('option', 'dateFormat', 'dd M, yy');
        }

        $("#item").keyup(function () {
            var that = this,
            numberOfItem = $(this).val();

        });


                    </script>

                }
